@{
    ViewBag.Title = "CreateTask";
    if (ViewData["id"].ToString() == "1")
    {
        Layout = "~/Views/Shared/_Home.cshtml";
    }
    else if (ViewData["id"].ToString() == "2")
    {
        Layout = "~/Views/Shared/Admin.cshtml";
    }
    else if (ViewData["id"].ToString() == "3")
    {
        Layout = "~/Views/Shared/Normal.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/CSR.cshtml";
    }
}
<div id="wrapper">
    <!-- Navigation -->
    <div id="page-wrapper" ng-app="requisition" ng-controller="reqCtrl">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header" style="text-align:center">Create Requisition</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Create Requisition
                        <button value="add" class="btn btn-primary fa fa-plus pull-right" ng-click="addItem()" />
                    </div>
                    <div class="panel-body">

                        <div class="col-lg-12" style="padding-bottom:20px">
                            <div class="col-lg-4">
                                <div class="col-lg-offset-3 col-lg-3"><h4>Serial No</h4></div>
                                <div class="col-lg-6">
                                    <input class="form-control" value="{{requisition.serialNo}} " disabled>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="col-lg-offset-3 col-lg-3"> <h4>Customer</h4></div>

                                <div class="col-lg-6">
                                    <select class="form-control" ng-options="customer.name for customer in requisition.customer" ng-model="selectedCustomer" data-ng-if="!requisition.formReq" ng-change="selectProjects()" ng-disabled="check"></select>
                                    <input class="form-control" type="text" data-ng-if="requisition.formReq" ng-model="requisition.customername" required="required" disabled>
                                    @*<select class="form-control" ng-options="customer.name for customer in requisition.customer" ng-model="selectedCustomer" ng-change="selectProjects()"  required></select>*@

                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="col-lg-offset-3 col-lg-3"><h4>Project</h4></div>
                                <div class="col-lg-6">
                                    <select class="form-control" ng-options="project.name for project in selectedProject" data-ng-if="!requisition.formReq" ng-model="projectSelected" ng-change="projectStore()" required ng-disabled="check"></select>
                                    <input class="form-control" type="text" data-ng-if="requisition.formReq" ng-model="requisition.projectname" required="required" disabled>



                                    @*<select class="form-control" ng-options="project.name for project in selectedProject" ng-model="projectSelected" required></select>*@
                                </div>
                            </div>
                            <div id="tab-2" class="tab-content overflow ">
                                <table class="table table-striped table-bordered table-hover" id="dataTables-examp" style="width:100%!important">
                                    <thead id="th">
                                        <tr>
                                            <th>S No</th>
                                            <th>Item Name</th>
                                            <th>Item Code</th>
                                            <th>Units</th>
                                            <th>Quantity Required</th>
                                            <th>Date Required</th>
                                            <th>Action</th>
                                        </tr>

                                    </thead>

                                    <tbody id="dynamic-Grid">
                                        <form ng-submit="submitRequis()">
                                            <tr ng-if="items.length>0" ng-repeat="item in items">
                                                <td><input class="form-control" type="number" value={{$index+1}} disabled></td>
                                                <td><input class="form-control" type="text" ng-model="item.itemName" placeholder="Item Description" ng-required="true"></td>
                                                <td><input class="form-control" type="text" ng-model="item.itemCode" placeholder="H-2017" ng-required="true"></td>
                                                <td><select class="form-control" ng-options="units.name for units in requisition.units" ng-model="item.units" required></select> </td>
                                                <td><input class="form-control" type="text" ng-model="item.quantity" placeholder="5" ng-required="true"></td>
                                                <td><input class="form-control" type="date" ng-model="item.dateReq" placeholder="mm/dd/yyyy" ng-required="true"></td>
                                                @*<td><input class="form-control" type="text" ng-model="item.issueQuant" ng-required="true"></td>*@
                                                <td><button value="sub" class="btn btn-danger fa fa-minus" ng-click="removeItem($index)" /></td>
                                            </tr>
                                        </form>
                                    </tbody>
                                </table>
                                <center>
                                    <div><button class="btn btn-warning center" ng-click="add()">Save </button></div>
                                </center>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/angular.min.js"></script>

<script type="text/javascript">
    var app = angular.module("requisition", []);
    app.controller("reqCtrl", function ($scope, $http) {

        $scope.message = $http.get('/api/RequisitionApi/' + 1).then(function (response) {
            console.log(response.data);
            $scope.requisition = response.data;
        });
        $scope.items = [];
        $scope.addItem = function () {

            var obj = { "itemName": "", "itemCode": "", "units": "", "quantity": "", "dateReq": ""};
            $scope.items.push(obj);

        }
        $scope.removeItem = function (index) {
            $scope.items.splice(index, 1);
        }
        $scope.selectProjects = function () {

            customerId = this.selectedCustomer.id;
            console.log(customerId);
            $scope.selectedProject = [];
            angular.forEach($scope.requisition.project, function (item) {
                if (item.custId == customerId) {
                    $scope.selectedProject.push(item);
                }
            });
        }


        $scope.projectStore = function () {
            projectId = this.projectSelected.id;
        }

        $scope.add = function () {
            console.log($scope.selectedCustomer);
            var keepGoing = true;
            angular.forEach($scope.items, function (item, index) {
                if (keepGoing) {
                    angular.forEach(item, function (value, key) {
                        if (keepGoing) {
                            if (value == "") {
                                keepGoing = false;
                                alert("Please Fill in the " + key + " field correctly of item number: " + index + 1);
                            }
                        }
                    });


                    //have to change format of date  then comparision will work
                    var today = new Date();
                    if (keepGoing) {
                        if (item.dateReq <= today) {
                            alert("Date required cannot be less than todays date. For Item Number: " + index + 1);
                            keepGoing = false;
                        }
                    }
                }

            });
            if (keepGoing) {

                if ($scope.requisition.formReq == false)
                {
                    $scope.requisition.customerId = customerId;
                    $scope.requisition.projectId = projectId;
                }               
                $scope.requisition.serialNo = $scope.requisition.serialNo;
                $scope.requisition.formReq = $scope.requisition.formReq;
                $scope.requisition.items = $scope.items;

                $scope.message = $http.post('/api/RequisitionApi/', $scope.requisition).then(function (response) {
                    alert("Sucessfully");
                    if ($scope.requisition.formReq) {
                        window.history.back();
                    }
                    else {
                        window.location.href = '/Requisition/ViewRequisition';
                    }

                });

            }
        }

    });

</script>
