@{
    ViewBag.Title = "ViewMessage";
    Layout = "~/Views/Shared/_Home.cshtml";
}
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Task/Ticket Conversation</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">

        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Task View
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6 ">
                                    <label>Ticket/Task No.</label>
                                </div>
                                <div class="col-lg-6 ">
                                    <label id="ticketno"></label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing" >
                                <div class="col-lg-6 ">
                                    <label>Task Name</label>
                                </div>
                                <div class="col-lg-6 ">
                                    <label id="taskname"></label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>

                            <div class="col-lg-12 spacing " style="height:125px;">
                                <div class="col-lg-6">
                                    <label>Description</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="Description"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative; padding-bottom: 100px ; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6 ">
                                    <label>Customer Code</label>
                                </div>
                                <div class="col-lg-6 ">
                                    <label id="custid"></label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6 ">
                                    <label>Customer Name</label>
                                </div>
                                <div class="col-lg-6 ">
                                    <label id="custname"></label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>Start Date</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="StartDate"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>End Date</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="EndDate"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>Email</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="email"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>SMS</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="sms"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>Assigned To</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="assign"></label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 40px; "> </p>
                            </div>
                            <div class="col-lg-12 spacing">
                                <div class="col-lg-6">
                                    <label>Created By</label>
                                </div>
                                <div class="col-lg-6">
                                    <label id="createdby"> </label>
                                </div>
                                <p style=" border-bottom: 1px solid gray; position:relative;padding-bottom: 30px; "> </p>
                            </div>
                        </div>
                        <!-- /.col-lg-6 (nested) -->
                        <!-- /.col-lg-6 (nested) -->
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <div>
            <div class="col-lg-6">
                <div class="panel panel-primary">
                    <div class="panel-heading" id="accordion">
                        <span class="glyphicon glyphicon-comment"></span> Conversation
                    </div>
                    <!-- Collapse starts here I guess -->
                </div>
                <div class="col-lg-12">
                    <div class="panel-collapse">
                        <div class="panel-body" style="overflow-y:scroll; height:390px;">
                            <!-- unordered list starts here -->
                            <ul class="chat" id="messageList">
                                <!-- list elements below for every user -->
                            </ul>
                            <!-- unordered lit ends here  -->
                        </div>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your message here..." onkeypress="if (event.keyCode == 13) { sendMessage() }" />
                                <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-chat" onclick="sendMessage()">
                                        Send
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- collapse ends here I guess^^ -->

                </div>
                <!-- /.panel -->
            </div>

        </div>

        <!-- /.col-lg-12 -->
        <!-- /.row -->
    </div>
</div>

<script>
    $(document).ready(function () {
        $.ajax({
            async: true,
            url: '/api/messageApi/',
            type: 'GET',
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data);
                for (var i = 0; i < data.responseList.length; i++) {
                    chatstyle(data.responseList[i]);
                }
                document.getElementById('ticketno').innerText = data.task_no;
                document.getElementById('taskname').innerText = data.task_name;
                document.getElementById('Description').innerText = data.Description;
                document.getElementById('custid').innerText = data.customercode;
                document.getElementById('custname').innerText = data.customername;
                document.getElementById('StartDate').innerText = data.sDate;
                document.getElementById('EndDate').innerText = data.eDate;
                document.getElementById('sms').innerText = data.SMS;
                document.getElementById('email').innerText = data.Email;
                document.getElementById('createdby').innerText = data.createdby;
                for (var i = 0; i < data.taggedUsers.length; i++) {
                    document.getElementById('assign').innerText = document.getElementById('assign').innerText + data.taggedUsers[i];
                }
            },
            error: function () { alert('Grid Not Loaded'); }
        });
    });

    function sendMessage() {
        var chat = document.getElementById("btn-input").value.trim();

        if (chat == null) {
            Alert("Please Enter Some Messege");
            return;
        }
        //else {
        //    if (navigator.geolocation) {
        //        navigator.geolocation.getCurrentPosition(showLocation);
        //    }
        //    else {
        //        alert('Geolocation non supported..');
        //    }

        //    function showLocation(position) {
        //  var locations = position.coords.latitude + "," + position.coords.longitude;

        var model = {
            msg: document.getElementById("btn-input").value,
            loc: "24.9258156,67.0524282"
        };
        console.log(model);
        $.ajax({
            async: false,
            url: '/api/messageApi/',
            type: 'PUT',
            data: JSON.stringify(model),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data == 1) {
                    var model = {
                        direction: "left",
                        initials: "ME",
                        location: "",
                        message: document.getElementById("btn-input").value,
                        name: "",
                        timeStamp: Date()
                    };
                    chatstyle(model);
                    document.getElementById("btn-input").value = "";
                }
                else { alert("Message could Not be Sent"); }
            },
            error: function () { alert('Grid Not Load'); }
        });
    }
    //   }
    //}



    function chatstyle(model) {

        //Appending Starts Here
        var ul = document.getElementById("messageList");
        //For Loop Starts Here
        // -------------------------------------------- Create HTML Attributes -----------------------------------------//
        var img = document.createElement('img');
        var li = document.createElement("li");
        var sp = document.createElement("span");
        var div = document.createElement("div");
        var div1 = document.createElement("div");
        var strong = document.createElement("strong");
        var small = document.createElement("small");
        var p = document.createElement("p");
        var span = document.createElement("span");
        var a = document.createElement("a");
        // -------------------------------------------- Append HTML Attributes Class Name--------------------------------//


        if (model.direction == "left") {
            li.className = "right clearfix";
            sp.className = "chat-img pull-left";
            img.src = "http://placehold.it/50/FA6F57/fff&amp;text=" + model.initials;
            strong.className = "primary-font";
            small.className = "pull-right text-muted";
            p.className = "pull-right";


        }
        else {
            li.className = "left clearfix";
            sp.className = "chat-img pull-right";
            img.src = "http://placehold.it/50/55C1E7/fff&text=" + model.initials;
            small.className = "text-muted";
            strong.className = "pull-right primary-font";

        }
        if (model.location != "") {
            var coordinates = model.location.split(",");
            a.href = "http://maps.google.com/?q=" + coordinates[0] + "," + coordinates[1];
            a.className = " fa fa-map-marker"
            div1.appendChild(a);
        }
        img.className = "img-circle";
        div.className = "chat-body clearfix";
        div1.className = "header";
        strong.className = "primary-font";

        span.className = "glyphicon glyphicon-time";
        // -------------------------------------------- Append HTML Attributes -----------------------------------------//
        p.textContent = model.message;

        span.textContent = " Date " + model.timeStamp.substring(0, 10) + " Time " + model.timeStamp.substring(11, 16);
        strong.textContent = model.name;
        sp.appendChild(img);
        li.appendChild(sp);
        li.appendChild(div);
        ul.appendChild(li);
        div.appendChild(div1);
        div1.appendChild(strong);
        div1.appendChild(small);
        small.appendChild(span);
        div.appendChild(p);
    }
</script>
